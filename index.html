<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report: IC Hand Hygiene Audit - โรงพยาบาลพุนพิน</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; color: #2c3e50; }
        .header-banner { background: linear-gradient(135deg, #16a085, #2ecc71); color: white; padding: 30px; border-radius: 0 0 30px 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        
        /* Card & Layout */
        .card { border-radius: 15px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; transition: 0.3s; }
        .section-title { border-left: 8px solid #16a085; padding-left: 15px; margin-bottom: 25px; color: #2c3e50; font-weight: bold; font-size: 1.25rem; }
        
        /* Dashboard Cards */
        .dash-card { background: white; border-radius: 15px; padding: 20px; text-align: center; border-bottom: 5px solid #16a085; height: 100%; }
        .dash-title { font-size: 0.85rem; color: #7f8c8d; margin-bottom: 8px; font-weight: 700; letter-spacing: 0.5px; }
        .dash-value { font-size: 2.2rem; font-weight: 800; display: block; line-height: 1; margin-bottom: 5px; }
        .dash-fraction { font-size: 0.9rem; color: #bdc3c7; font-weight: 400; }

        /* Table Aesthetics */
        .table { font-size: 0.85rem; border-collapse: separate; border-spacing: 0; }
        .table thead th { background-color: #2c3e50; color: white; border: none; padding: 12px 8px; font-weight: 500; }
        .table-hover tbody tr:hover { background-color: #f1f8e9 !important; }
        
        .bg-label { background-color: #f8f9fa !important; font-weight: bold; position: sticky; left: 0; z-index: 10; border-right: 2px solid #dee2e6 !important; color: #2c3e50; }
        .cell-pct { font-weight: 800; display: block; font-size: 0.9rem; }
        .cell-frac { font-size: 0.7rem; color: #95a5a6; display: block; }
        
        /* Specific Table Colors */
        .head-m { background-color: #34495e !important; border-right: 1px solid #455a64 !important; }
        .head-comp { background-color: #27ae60 !important; color: white !important; }
        .table-primary { background-color: #e3f2fd !important; color: #0d47a1 !important; }
        .table-success { background-color: #e8f5e9 !important; color: #1b5e20 !important; }

        /* Status Colors */
        .text-hundred { color: #e74c3c !important; font-weight: 900; text-shadow: 0px 0px 1px rgba(0,0,0,0.1); } 
        .text-success-custom { color: #27ae60 !important; font-weight: 700; } 
        
        .chart-container { position: relative; width: 100%; }
        .chart-label { font-weight: bold; color: #34495e; margin-bottom: 15px; font-size: 1rem; }

        @media print { .no-print { display: none !important; } .card { box-shadow: none; border: 1px solid #eee; } }
    </style>
</head>
<body>

<div class="header-banner text-center mb-5 no-print">
    <h2 class="fw-bold mb-1"><i class="fas fa-hand-holding-medical"></i> IC Hand Hygiene Audit Report</h2>
    <p class="mb-0 opacity-75">โรงพยาบาลพุนพิน | Phunphin Hospital Dashboard</p>
</div>

<div class="container-fluid px-lg-5">
    <div class="card p-4 no-print border-0 shadow-sm">
        <div class="row align-items-end g-3 justify-content-center">
            <div class="col-md-3">
                <label class="form-label fw-bold small text-muted"><i class="fas fa-filter"></i> รูปแบบการแสดงรายงาน</label>
                <select class="form-select border-success-subtle" id="filterType" onchange="toggleFilterInputs()">
                    <option value="all">1. ข้อมูลทั้งหมด</option>
                    <option value="month">2. รายเดือน</option>
                    <option value="year">3. รายปี</option>
                    <option value="range">4. กำหนดช่วงวันที่</option>
                </select>
            </div>
            <div id="monthFilterGroup" class="col-md-2" style="display:none;"><label class="small text-muted">เลือกเดือน</label><input type="month" id="filterMonth" class="form-control"></div>
            <div id="yearFilterGroup" class="col-md-2" style="display:none;"><label class="small text-muted">ระบุปี (ค.ศ.)</label><input type="number" id="filterYear" class="form-control" placeholder="2026"></div>
            <div id="rangeFilterGroupStart" class="col-md-2" style="display:none;"><label class="small text-muted">จากวันที่</label><input type="date" id="filterStart" class="form-control"></div>
            <div id="rangeFilterGroupEnd" class="col-md-2" style="display:none;"><label class="small text-muted">ถึงวันที่</label><input type="date" id="filterEnd" class="form-control"></div>
            <div class="col-md-2">
                <button class="btn btn-success w-100 fw-bold py-2 shadow-sm" onclick="updateReports()"><i class="fas fa-sync-alt"></i> อัปเดตข้อมูล</button>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3"><div class="dash-card"><div class="dash-title">Hand Wash Overall</div><div class="dash-value text-primary" id="hw_val">0%</div><div class="dash-fraction" id="hw_frac">(0/0)</div></div></div>
        <div class="col-md-3"><div class="dash-card"><div class="dash-title">Hand Rub Overall</div><div class="dash-value text-info" id="hr_val">0%</div><div class="dash-fraction" id="hr_frac">(0/0)</div></div></div>
        <div class="col-md-3"><div class="dash-card" style="border-bottom-color: #27ae60;"><div class="dash-title">HW+HR Overall</div><div class="dash-value text-success" id="comp_val">0%</div><div class="dash-fraction" id="comp_frac">(0/0)</div></div></div>
        <div class="col-md-3"><div class="dash-card" style="border-bottom-color: #f39c12;"><div class="dash-title">ภาพรวมความพร้อมอุปกรณ์</div><div class="dash-value text-warning" id="equip_val">0%</div><div class="dash-fraction" id="equip_frac">(0/0)</div></div></div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-4">
            <div class="card p-4 h-100"><h6 class="chart-label"><i class="fas fa-chart-pie me-2"></i>สัดส่วนการทำความสะอาดมือ(ครั้ง)</h6><div class="chart-container" style="height: 300px;"><canvas id="pieChart"></canvas></div></div>
        </div>
        <div class="col-lg-4">
            <div class="card p-4 h-100"><h6 class="chart-label"><i class="fas fa-chart-bar me-2"></i>อัตราทำความสะอาดมือแต่ละโอกาส 5 Moments (HR+HW)(%)</h6><div class="chart-container" style="height: 300px;"><canvas id="momentChart"></canvas></div></div>
        </div>
        <div class="col-lg-4">
            <div class="card p-4 h-100"><h6 class="chart-label"><i class="fas fa-chart-line me-2"></i>แนวโน้มความร่วมมือล้างมือ(%HW+HR)รายเดือน</h6><div class="chart-container" style="height: 300px;"><canvas id="trendChart"></canvas></div></div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-6"><div class="card p-4 h-100"><h6 class="chart-label">%HR+HW ตามแผนกแยกราย Moment</h6><div style="height: 350px;"><canvas id="deptMomentChart"></canvas></div></div></div>
        <div class="col-lg-6"><div class="card p-4 h-100"><h6 class="chart-label">%HR+HW ตามวิชาชีพแยกราย Moment</h6><div style="height: 350px;"><canvas id="roleMomentChart"></canvas></div></div></div>
    </div>

    <div id="reportArea">
        <h5 class="section-title"><i class="fas fa-table me-2"></i>ข้อมูลสรุปผลการวิเคราะห์</h5>
        
        <div class="card overflow-hidden">
            <div class="bg-dark p-3"><h6 class="text-white mb-0 small">อัตราการทำความสะอาดมือแต่ละโอกาส แยกราย Moment</h6></div>
            <div class="table-responsive">
                <table class="table table-hover text-center align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="text-start" style="width: 250px;">Moment Description</th>
                            <th class="head-comp">HW + HR (%)</th>
                            <th>HW (%)</th>
                            <th>HR (%)</th>
                            <th>ไม่ล้างมือ</th>
                            <th>สวมถุงมือ</th>
                        </tr>
                    </thead>
                    <tbody id="momentTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card mt-4">
            <div class="bg-dark p-3 d-flex justify-content-between align-items-center">
                <h6 class="text-white mb-0 small">อัตราทำความสะอาดมือ แยกตาม Moments และแผนก</h6>
                <span class="badge bg-secondary">Matrix View</span>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle table-matrix table-hover mb-0" style="min-width:1500px;">
                    <thead>
                        <tr>
                            <th rowspan="2" class="align-middle bg-label">แผนก (Department)</th>
                            <th colspan="5" class="head-m">M1: ก่อนสัมผัสผู้ป่วย</th>
                            <th colspan="5" class="head-m">M2: ก่อนทำหัตถการปลอดเชื้อ</th>
                            <th colspan="5" class="head-m">M3: หลังสัมผัสสารคัดหลั่งผู้ป่วย</th>
                            <th colspan="5" class="head-m">M4: หลังสัมผัสผู้ป่วย</th>
                            <th colspan="5" class="head-m">M5: หลังสัมผัสสิ่งรอบตัวผู้ป่วย</th>
                        </tr>
                        <tr>
                            <th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th>
                            <th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th>
                            <th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th>
                            <th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th>
                            <th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th>
                        </tr>
                    </thead>
                    <tbody id="matrixTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card mt-4">
            <div class="bg-dark p-3"><h6 class="text-white mb-0 small">อัตราทำความสะอาดมือ แยกตาม Moments และวิชาชีพ</h6></div>
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle table-matrix table-hover mb-0" style="min-width:1500px;">
                    <thead>
                        <tr>
                            <th rowspan="2" class="align-middle bg-label">วิชาชีพ (Profession)</th>
                            <th colspan="5" class="head-m">M1</th><th colspan="5" class="head-m">M2</th><th colspan="5" class="head-m">M3</th><th colspan="5" class="head-m">M4</th><th colspan="5" class="head-m">M5</th>
                        </tr>
                        <tr>
                            <th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th>
                            <th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th>
                            <th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th>
                            <th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th>
                            <th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th>
                        </tr>
                    </thead>
                    <tbody id="matrixRoleTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card mt-4">
            <div class="bg-warning p-3"><h6 class="mb-0 small fw-bold"><i class="fas fa-tools me-2"></i>ความพร้อมใช้อุปกรณ์แยกตามแผนก (%)</h6></div>
            <div class="table-responsive">
                <table class="table table-hover text-center align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-start bg-label">แผนก</th>
                            <th>อ่างล้างมือ</th><th>สบู่เหลว</th><th>4% Chlorhexidine</th><th>Alcohol hand rub</th>
                            <th>กระดาษเช็ดมือ</th><th>โปสเตอร์แสดงวิธีการล้างมือ</th><th>ถังขยะใส่กระดาษเช็ดมือ</th>
                            <th class="table-primary">ความพร้อมภาพรวม (%)</th>
                        </tr>
                    </thead>
                    <tbody id="equipDeptTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="row g-4 mt-2 mb-5">
            <div class="col-md-6">
                <div class="card h-100 overflow-hidden">
                    <div class="p-3 bg-light border-bottom fw-bold">ภาพรวมความร่วมมือแยกตามแผนก</div>
                    <table class="table table-hover text-center mb-0">
                        <thead><tr><th>แผนก</th><th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th></tr></thead>
                        <tbody id="deptTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100 overflow-hidden">
                    <div class="p-3 bg-light border-bottom fw-bold">ภาพรวมความร่วมมือแยกตามวิชาชีพ</div>
                    <table class="table table-hover text-center mb-0">
                        <thead><tr><th>วิชาชีพ</th><th class="head-comp">HW+HR</th><th>HW</th><th>HR</th><th>ไม่ล้างมือ</th><th>สวมถุงมือ</th></tr></thead>
                        <tbody id="roleTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx58a1xS-6se0SXJ_pyfPsk7wIPZlz9I6OGcksrA3ohJ9hkHloZVTbdD9a27HpbGK8QbQ/exec"; 
    let database = [];
    let charts = {};

    window.onload = fetchDataFromSheet;
    function fetchDataFromSheet() { fetch(SCRIPT_URL).then(res => res.json()).then(data => { database = data; updateReports(); }); }
    
    function toggleFilterInputs() {
        const type = document.getElementById('filterType').value;
        document.getElementById('monthFilterGroup').style.display = (type === 'month') ? 'block' : 'none';
        document.getElementById('yearFilterGroup').style.display = (type === 'year') ? 'block' : 'none';
        document.getElementById('rangeFilterGroupStart').style.display = (type === 'range') ? 'block' : 'none';
        document.getElementById('rangeFilterGroupEnd').style.display = (type === 'range') ? 'block' : 'none';
    }

    function updateReports() {
        const type = document.getElementById('filterType').value;
        let filtered = database;
        if (type === 'month') {
            const val = document.getElementById('filterMonth').value;
            if (val) filtered = database.filter(d => d.obsDate && d.obsDate.substring(0, 7) === val);
        } else if (type === 'year') {
            const val = document.getElementById('filterYear').value;
            if (val) filtered = database.filter(d => d.obsDate && d.obsDate.substring(0, 4) === val);
        } else if (type === 'range') {
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            if (start && end) filtered = database.filter(d => { const dD = d.obsDate.substring(0, 10); return dD >= start && dD <= end; });
        }
        if (filtered.length === 0) { alert("ไม่พบข้อมูล"); resetDashboard(); return; }
        render(filtered);
    }

    function resetDashboard() {
        ['hw_val', 'hr_val', 'comp_val', 'equip_val'].forEach(id => document.getElementById(id).innerText = '0%');
        ['matrixTableBody', 'matrixRoleTableBody', 'momentTableBody', 'deptTableBody', 'roleTableBody', 'equipDeptTableBody'].forEach(id => document.getElementById(id).innerHTML = '');
        for (let key in charts) { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }
    }

    function getPercentColor(pct) {
        let val = parseFloat(pct);
        if (val === 0 || isNaN(val)) return 'text-muted opacity-25'; 
        if (val === 100) return 'text-hundred'; 
        if (val >= 80) return 'text-success-custom'; 
        return ''; 
    }

    function render(data) {
        let hw = 0, hr = 0, none = 0, glove = 0, eqTotalRaw = 0;
        let mStats = Array.from({ length: 5 }, () => ({ hw: 0, hr: 0, none: 0, glove: 0 }));

        data.forEach(d => {
            if(d.m) d.m.forEach((v, i) => {
                if(v==='HW') { hw++; mStats[i].hw++; }
                else if(v==='HR') { hr++; mStats[i].hr++; }
                else if(v==='None') { none++; mStats[i].none++; }
                else if(v==='Glove') { glove++; mStats[i].glove++; }
            });
            if(d.equips) d.equips.forEach(v => eqTotalRaw += v);
        });

        const totalOpp = hw + hr + none + glove; 
        const totalEquipPossible = data.length * 7;
        
        document.getElementById('hw_val').innerText = ((hw / totalOpp) * 100).toFixed(1) + `%`;
        document.getElementById('hw_frac').innerText = `(${hw}/${totalOpp})`;
        document.getElementById('hr_val').innerText = ((hr / totalOpp) * 100).toFixed(1) + `%`;
        document.getElementById('hr_frac').innerText = `(${hr}/${totalOpp})`;
        document.getElementById('comp_val').innerText = (((hw + hr) / totalOpp) * 100).toFixed(1) + `%`;
        document.getElementById('comp_frac').innerText = `(${hw + hr}/${totalOpp})`;
        document.getElementById('equip_val').innerText = ((eqTotalRaw / totalEquipPossible) * 100).toFixed(1) + `%`;
        document.getElementById('equip_frac').innerText = `(${eqTotalRaw}/${totalEquipPossible})`;

        drawPie(hw, hr, none, glove);
        drawMomentBar(mStats);
        drawTrend(data);
        drawDeptMomentChart(data);
        drawRoleMomentChart(data);

        renderTables(data, mStats);
        renderMatrixHorizontal(data, 'dept', 'matrixTableBody'); 
        renderMatrixHorizontal(data, 'role', 'matrixRoleTableBody');
        renderEquipDept(data);
    }

    function renderMatrixHorizontal(data, field, bodyId) {
        const body = document.getElementById(bodyId);
        body.innerHTML = '';
        const keys = [...new Set(data.map(d => d[field]))].sort();

        keys.forEach(keyVal => {
            const filteredData = data.filter(d => d[field] === keyVal);
            let row = `<tr><td class="text-start ps-2 bg-label">${keyVal}</td>`;
            for (let mIdx = 0; mIdx < 5; mIdx++) {
                const mTotal = filteredData.filter(d => d.m && d.m[mIdx] && d.m[mIdx] !== "").length;
                const hwCount = filteredData.filter(d => d.m && d.m[mIdx] === 'HW').length;
                const hrCount = filteredData.filter(d => d.m && d.m[mIdx] === 'HR').length;
                const compCount = hwCount + hrCount;
                const compPct = mTotal > 0 ? ((compCount / mTotal) * 100).toFixed(1) : 0;
                row += `<td class="table-success">
                            ${compCount > 0 ? `<span class="cell-pct ${getPercentColor(compPct)}">${compPct}%</span><span class="cell-frac">(${compCount}/${mTotal})</span>` : "-"}
                        </td>`;
                ['HW', 'HR', 'None', 'Glove'].forEach(beh => {
                    const count = filteredData.filter(d => d.m && d.m[mIdx] === beh).length;
                    if (mTotal > 0 && count > 0) {
                        const pct = ((count / mTotal) * 100).toFixed(1);
                        row += `<td><span class="cell-pct ${getPercentColor(pct)}">${pct}%</span><span class="cell-frac">(${count}/${mTotal})</span></td>`;
                    } else { row += `<td>-</td>`; }
                });
            }
            row += `</tr>`;
            body.innerHTML += row;
        });
    }

    function renderTables(data, mStats) {
        const mBody = document.getElementById('momentTableBody'); 
        mBody.innerHTML = '';
        const momentLabels = ["ก่อนสัมผัสผู้ป่วย", "ก่อนทำหัตถการปลอดเชื้อ", "หลังสัมผัสสารคัดหลั่งผู้ป่วย", "หลังสัมผัสผู้ป่วย", "หลังสัมผัสสิ่งรอบตัวผู้ป่วย"];
        momentLabels.forEach((l, idx) => {
            const m = mStats[idx];
            const total = m.hw + m.hr + m.none + m.glove;
            const fmt = (c) => { 
                if (total === 0 || c === 0) return "-"; 
                let pct = ((c/total)*100).toFixed(1); 
                return `<span class="${getPercentColor(pct)}">${pct}%</span> <br><small class="text-muted">(${c}/${total})</small>`; 
            };
            const hwHrSum = m.hw + m.hr;
            const fmtTotal = () => {
                if (total === 0 || hwHrSum === 0) return "-";
                let pct = ((hwHrSum / total) * 100).toFixed(1);
                return `<span class="${getPercentColor(pct)}">${pct}%</span> <br><small class="text-muted">(${hwHrSum}/${total})</small>`;
            };
            mBody.innerHTML += `<tr><td class="text-start fw-bold bg-light">${l}</td><td class="table-primary">${fmtTotal()}</td><td>${fmt(m.hw)}</td><td>${fmt(m.hr)}</td><td>${fmt(m.none)}</td><td>${fmt(m.glove)}</td></tr>`;
        });
        renderTableFraction(data, 'dept', 'deptTableBody');
        renderTableFraction(data, 'role', 'roleTableBody');
    }

    function renderTableFraction(data, field, bodyId) {
        const body = document.getElementById(bodyId); body.innerHTML = '';
        const keys = [...new Set(data.map(d => d[field]))].sort();
        keys.forEach(k => {
            let f = data.filter(d => d[field] === k);
            let s = {HW:0, HR:0, None:0, Glove:0};
            f.forEach(d => { if(d.m) d.m.forEach(v => { if(v) s[v]++; }); });
            const total = s.HW + s.HR + s.None + s.Glove;
            const fmt = (c) => { 
                if (total === 0 || c === 0) return "-"; 
                let pct = ((c/total)*100).toFixed(1); 
                return `<span class="${getPercentColor(pct)}">${pct}%</span> <br><small class="text-muted">(${c}/${total})</small>`; 
            };
            const compSum = s.HW + s.HR;
            const compPct = total > 0 ? ((compSum / total) * 100).toFixed(1) : 0;
            const compDisplay = compSum > 0 ? `<span class="${getPercentColor(compPct)} fw-bold">${compPct}%</span><br><small class="text-muted">(${compSum}/${total})</small>` : "-";
            body.innerHTML += `<tr><td class="text-start ps-2 fw-bold bg-light">${k}</td><td class="table-success">${compDisplay}</td><td>${fmt(s.HW)}</td><td>${fmt(s.HR)}</td><td>${fmt(s.None)}</td><td>${fmt(s.Glove)}</td></tr>`;
        });
    }

    function renderEquipDept(data) {
        const body = document.getElementById('equipDeptTableBody');
        body.innerHTML = '';
        const depts = [...new Set(data.map(d => d.dept))].sort();
        depts.forEach(dept => {
            const f = data.filter(d => d.dept === dept);
            let row = `<tr><td class="text-start ps-2 fw-bold bg-light">${dept}</td>`;
            let deptSumScores = 0;
            for(let i=0; i<7; i++) {
                let score = f.reduce((acc, d) => acc + (d.equips ? d.equips[i] : 0), 0);
                deptSumScores += score;
                let pct = f.length > 0 ? ((score / f.length) * 100).toFixed(1) : 0;
                row += `<td>${score > 0 ? `<span class="${getPercentColor(pct)}">${pct}%<br><small class="text-muted">(${score}/${f.length})</small></span>` : "-"}</td>`;
            }
            let avg = (f.length > 0) ? ((deptSumScores / (f.length * 7)) * 100).toFixed(1) : 0;
            row += `<td class="table-primary fw-bold">${avg > 0 ? `<span class="${getPercentColor(avg)}">${avg}%</span>` : "-"}</td></tr>`;
            body.innerHTML += row;
        });
    }

    // --- Chart functions (Modified Y-Axis) ---
    const commonYAxis = { 
        beginAtZero: true, 
        max: 100, 
        ticks: { stepSize: 20 } 
    };

    function drawPie(hw, hr, none, glove) { 
        if(charts.pie) charts.pie.destroy(); 
        charts.pie = new Chart(document.getElementById('pieChart'), { 
            type: 'doughnut', 
            data: { labels: ['HW', 'HR', 'ไม่ล้างมือ', 'สวมถุงมือ'], datasets: [{ data: [hw, hr, none, glove], backgroundColor: ['#2ecc71', '#3498db', '#e74c3c', '#f1c40f'] }] }, 
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, cutout: '70%' } 
        }); 
    }

    function drawMomentBar(mStats) { 
        if(charts.moment) charts.moment.destroy(); 
        const scores = mStats.map(m => {
            const total = m.hw + m.hr + m.none + m.glove;
            return total > 0 ? (((m.hw + m.hr) / total) * 100).toFixed(1) : 0;
        });
        charts.moment = new Chart(document.getElementById('momentChart'), { 
            type: 'bar', 
            data: { labels: ["M1 ก่อนสัมผัสผู้ป่วย", "M2 ก่อนทำหัตถการปลอดเชื้อ", "M3 หลังสัมผัสสารคัดหลั่งผู้ป่วย", "M4 หลังสัมผัสผู้ป่วย", "M5 หลังสัมผัสสิ่งรอบตัวผู้ป่วย"], datasets: [{ label: 'HW+HR (%)', data: scores, backgroundColor: '#16a085', borderRadius: 8 }] }, 
            options: { maintainAspectRatio: false, scales: { y: commonYAxis } } 
        }); 
    }

    function drawTrend(data) {
        if(charts.trend) charts.trend.destroy();
        const monthlyData = {};
        database.forEach(d => {
            if(!d.obsDate) return;
            const month = d.obsDate.substring(0, 7);
            if(!monthlyData[month]) monthlyData[month] = { pass: 0, total: 0 };
            if(d.m) d.m.forEach(v => { if(v){ monthlyData[month].total++; if(v === 'HW' || v === 'HR') monthlyData[month].pass++; } });
        });
        const labels = Object.keys(monthlyData).sort();
        charts.trend = new Chart(document.getElementById('trendChart'), { 
            type: 'line', 
            data: { labels: labels, datasets: [{ label: 'Trend (%)', data: labels.map(l => ((monthlyData[l].pass / monthlyData[l].total) * 100).toFixed(1)), borderColor: '#16a085', tension: 0.4, fill: true, backgroundColor: 'rgba(22, 160, 133, 0.1)' }] }, 
            options: { maintainAspectRatio: false, scales: { y: commonYAxis } } 
        });
    }

    function drawDeptMomentChart(data) {
        if(charts.deptMoment) charts.deptMoment.destroy();
        const depts = [...new Set(data.map(d => d.dept))].sort();
        const colors = ['#1abc9c', '#3498db', '#9b59b6', '#f1c40f', '#e67e22'];
        const datasets = [0, 1, 2, 3, 4].map(mIdx => ({
            label: `M${mIdx+1}`,
            data: depts.map(dept => {
                const f = data.filter(d => d.dept === dept);
                const total = f.filter(d => d.m && d.m[mIdx] && d.m[mIdx] !== "").length;
                const comp = f.filter(d => d.m && (d.m[mIdx] === 'HW' || d.m[mIdx] === 'HR')).length;
                return total > 0 ? ((comp / total) * 100).toFixed(1) : 0;
            }),
            backgroundColor: colors[mIdx], borderRadius: 4
        }));
        charts.deptMoment = new Chart(document.getElementById('deptMomentChart'), {
            type: 'bar', data: { labels: depts, datasets: datasets },
            options: { maintainAspectRatio: false, scales: { y: commonYAxis } }
        });
    }

    function drawRoleMomentChart(data) {
        if(charts.roleMoment) charts.roleMoment.destroy();
        const roles = [...new Set(data.map(d => d.role))].sort();
        const colors = ['#1abc9c', '#3498db', '#9b59b6', '#f1c40f', '#e67e22'];
        const datasets = [0, 1, 2, 3, 4].map(mIdx => ({
            label: `M${mIdx+1}`,
            data: roles.map(role => {
                const f = data.filter(d => d.role === role);
                const total = f.filter(d => d.m && d.m[mIdx] && d.m[mIdx] !== "").length;
                const comp = f.filter(d => d.m && (d.m[mIdx] === 'HW' || d.m[mIdx] === 'HR')).length;
                return total > 0 ? ((comp / total) * 100).toFixed(1) : 0;
            }),
            backgroundColor: colors[mIdx], borderRadius: 4
        }));
        charts.roleMoment = new Chart(document.getElementById('roleMomentChart'), {
            type: 'bar', data: { labels: roles, datasets: datasets },
            options: { maintainAspectRatio: false, scales: { y: commonYAxis } }
        });
    }
</script>
</body>
</html>
